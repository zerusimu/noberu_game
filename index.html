<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>薬屋見習いの冒険</title>
<link rel="stylesheet" href="./css/style.css">
</head>
<body>
    <div id="background"></div> <!-- 📌 背景専用の要素 -->
    <div id="gameContainer">
        <!-- キャラクター画像を含む枠 -->
        <div id="characterContainer">
            <img id="character" src="" alt="キャラクター">
                </div>
            <div id="textOverlay">
             <div id="characterName"></div> <!-- キャラ名を表示 -->
                <p id="storyText">読み込み中...</p>
                <div id="choices"></div>
        
        </div>
<div id="gameMenu">
    <button onclick="saveGame()">セーブ</button>
    <button onclick="autoMode()">オート</button>
    <button onclick="skipText()">スキップ</button>
    <button onclick="loadGame()">ロード</button>
</div>
</div>

<script>
let allScenes = {}; // ここに全シーンをまとめる

// JSONファイルを読み込んで allScenes に追加
async function loadJson(file) {
  try {
    const response = await fetch(`./data/${file}`);
    const json = await response.json();
    allScenes = { ...allScenes, ...json }; // マージ
  } catch (err) {
    console.error(`読み込み失敗: ${file}`, err);
  }
}

// 必要なすべてのJSONをロード
async function loadAllScenes() {
  const files = ["story.json", "okane.json", "kenkou.json","zikan.json","zikokeihatu.json"];
  for (const file of files) {
    await loadJson(file);
  }
}

// シーンを表示
async function loadScene(scene) {
  try {
    // allScenes がまだ空ならロードする
    if (Object.keys(allScenes).length === 0) {
      await loadAllScenes();
    }

    const storyData = allScenes[scene];
    if (!storyData) {
      console.error("シーンが見つかりません:", scene);
      return;
    }

    // 背景
    if (storyData.background) {
      const bgDiv = document.getElementById("background");
      bgDiv.style.backgroundImage = `url('./images/${storyData.background}')`;
    }

    // テキスト
    document.getElementById("storyText").innerHTML = storyData.text;

    // キャラクター
    const characterContainer = document.getElementById("characterContainer");
    characterContainer.innerHTML = "";

    let speakingCharacterName = "";
    if (storyData.characters) {
      storyData.characters.forEach(char => {
        let img = document.createElement("img");
        img.src = `./characters/${char.image}`;
        img.classList.add("character");

        if (char.position) img.classList.add(char.position);
        if (char.speaking) {
          img.classList.add("active");
          speakingCharacterName = char.name || "";
        }

        characterContainer.appendChild(img);
      });
    }

    const characterNameDiv = document.getElementById("characterName");
    characterNameDiv.textContent = speakingCharacterName;
    characterNameDiv.style.display = speakingCharacterName ? "block" : "none";


function updateCharacterContainer() {
  const container = document.getElementById("characterContainer");
  const characters = container.querySelectorAll(".character");
  container.className = ""; // クラスリセット
  if (characters.length === 2) {
    container.classList.add("two");
  } else if (characters.length >= 3) {
    container.classList.add("three");
  }
}



    updateCharacterContainer();

    // ✅ 選択肢
    const choicesDiv = document.getElementById("choices");
    choicesDiv.innerHTML = "";
    (storyData.choices || []).forEach(choice => {
      let button = document.createElement("button");
      button.textContent = choice.text;
      button.onclick = () => loadScene(choice.next);
      choicesDiv.appendChild(button);
    });

  } catch (err) {
    console.error("エラー:", err);
  }
}

// 初回ロード
loadScene("top");
</script>


</body>
</html>